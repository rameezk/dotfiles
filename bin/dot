#!/usr/bin/env python

import os
import typer


app = typer.Typer()
dotfiles_dir = "~/.config/dotfiles"


def info(msg: str):
    typer.secho(msg, fg=typer.colors.MAGENTA)


def success(msg: str):
    typer.secho(msg, fg=typer.colors.BRIGHT_GREEN)


def error(msg: str):
    typer.secho(msg, fg=typer.colors.BRIGHT_RED)


def run_command(command: str):
    info(f"> {command}")
    return os.system(command)


@app.command(help="Open dotfiles in $EDITOR")
def edit(vim: bool = False):
    if vim:
        editor = "vim"
    else:
        editor = "emacsclient --no-wait"

    run_command(f"{editor} $(find {dotfiles_dir} -type f -not -path '*/\.git/*' | fzf)")


@app.command(help="Rebuild configuration and activate it")
def rebuild(with_traces: bool = False):
    info("üî® Rebuilding environment")

    if with_traces:
        info("Tracing on")
        cmd = "cd {dotfiles_dir} && nix build --show-trace .#rohan"
    else:
        cmd = "cd {dotfiles_dir} && nix build .#rohan"

    exit_code = run_command(f"cd {dotfiles_dir} && nix build .#rohan")
    if exit_code == 0:
        info("‚úîÔ∏è Activating environment")
        run_command(f"cd {dotfiles_dir} && ./result/activate")
        success("‚ú® Done")
    else:
        error("‚ùå Something went wrong")


@app.command(help="Choose a generation to rollback to")
def rollback(help="Rollback configuration"):
    info("Listing generations")
    generation = run_command(
        "$(home-manager generations | fzf | awk '{ print $7 }')/activate"
    )
    success("‚ú® Done")


if __name__ == "__main__":
    app()
